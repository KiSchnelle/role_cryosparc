---
- name: Download cryosparc_master.
  ansible.builtin.get_url:
    url: "https://get.cryosparc.com/download/master-latest/{{ license }}"
    dest: "{{ cryosparc_user_home }}/cryosparc_master.tar.gz"
  when: (standalone or master) and install_from_download

- name: Download cryosparc_worker.
  ansible.builtin.get_url:
    url: "https://get.cryosparc.com/download/worker-latest/{{ license }}"
    dest: "{{ cryosparc_user_home }}/cryosparc_worker.tar.gz"
  when: (worker or standalone) and install_from_download

- name: Extract cryosparc_master.
  ansible.builtin.unarchive:
    src: "{{ cryosparc_user_home }}/cryosparc_master.tar.gz"
    dest: "{{ cryosparc_user_home }}/cryosparc_master"
  when: (standalone or master) and install_from_download

- name: Extract cryosparc_worker.
  ansible.builtin.unarchive:
    src: "{{ cryosparc_user_home }}/cryosparc_worker.tar.gz"
    dest: "{{ cryosparc_user_home }}/cryosparc_worker"
  when: (worker or standalone) and install_from_download

- name: Install cryosparc_master.
  ansible.builtin.shell:
    cmd: "./install.sh --license {{ license }} --hostname {{ ansible_hostname }} --dbpath {{ database_path }} --port {{ cryosparc_port }} --yes"
    chdir: "{{ cryosparc_user_home }}/cryosparc_master"
  when: master

- name: Install cryosparc standalone.
  ansible.builtin.shell:
    cmd: "{{ item.command }}"
    chdir: "{{ cryosparc_user_home }}/cryosparc_master"
  with_items:
    - {
        command: "./install.sh --license {{ license }} --worker_path {{ cryosparc_user_home }}/cryosparc_worker --cudapath {{ cuda_path }} --ssdpath {{ ssd_path }} --port {{ cryosparc_port }} --yes",
        ssd: true,
      }
    - {
        command: "./install.sh --license {{ license }} --worker_path {{ cryosparc_user_home }}/cryosparc_worker --cudapath {{ cuda_path }} --port {{ cryosparc_port }} --yes",
        ssd: false,
      }
  when: standalone and item.ssd == ssd

- name: Install cryosparc_worker.
  ansible.builtin.shell:
    cmd: "./install.sh --license {{ license }} --cudapath {{ cuda_path }} --yes"
    chdir: "{{ cryosparc_user_home }}/cryosparc_worker"
  when: worker

- name: Start cryosparc.
  ansible.builtin.shell:
    cmd: "./bin/cryosparccm start"
  when: standalone or master

- name: Connect worker.
  ansible.builtin.shell:
    cmd: "{{ item.command }}"
    chdir: "{{ cryosparc_user_home }}/cryosparc_worker"
  with_items:
    - {
        command: "./bin/cryosparcw connect --worker {{ ansible_hostname }} --master {{ cryosparc_master_hostname }} --port {{ cryosparc_port }} --ssdpath {{ ssd_path }} --lane {{ lane }} --newlane",
        ssd: true,
        newlane: true,
      }
    - {
        command: "./bin/cryosparcw connect --worker {{ ansible_hostname }} --master {{ cryosparc_master_hostname }} --port {{ cryosparc_port }} --nossd --lane {{ lane }} --newlane",
        ssd: false,
        newlane: true,
      }
    - {
        command: "./bin/cryosparcw connect --worker {{ ansible_hostname }} --master {{ cryosparc_master_hostname }} --port {{ cryosparc_port }} --ssdpath {{ ssd_path }} --lane {{ lane }}",
        ssd: true,
        newlane: false,
      }
    - {
        command: "./bin/cryosparcw connect --worker {{ ansible_hostname }} --master {{ cryosparc_master_hostname }} --port {{ cryosparc_port }} --nossd --lane {{ lane }}",
        ssd: false,
        newlane: false,
      }
  when: worker and item.ssd == ssd and item.newlane == new_lane
